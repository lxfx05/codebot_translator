<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat con Gradient Theme</title>
<style>
  :root {
    /* Light Mode */
    --bg: #f5f5f5;
    --gradient-start: #232526;
    --gradient-end: #757F9A;
    --text-color: #111;
    --user-bubble: #fafafa;
    --bot-bubble: #e8e8e8;
    --code-fg: #111;
  }

  body[data-theme="dark"] {
    /* Dark Mode */
    --bg: #101010;
    --gradient-start: #232526;
    --gradient-end: #414445;
    --text-color: #f0f0f0;
    --user-bubble: #2c2c2c;
    --bot-bubble: #1f1f1f;
    --code-fg: #f5f5f5;
  }

  body {
    margin:0; font-family:Arial, sans-serif;
    background:var(--bg);
    color:var(--text-color);
    transition: background 0.6s ease, color 0.6s ease;
  }

  header {
    display:flex; justify-content:space-between; align-items:center;
    padding:10px; 
    background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
    color:var(--text-color);
    transition: background 1s ease-in-out, color 0.6s ease;
    background-size: 200% 200%;
    animation: gradientMove 6s ease infinite;
  }

  header input {
    flex:1; padding:8px; border-radius:6px; border:none; margin-right:6px;
  }
  #toggleTheme {
    padding:8px 14px; border-radius:20px; border:none; cursor:pointer;
    background:rgba(255,255,255,0.15); color:var(--text-color);
    transition: background 0.3s, color 0.6s ease;
  }
  #toggleTheme:hover { background:rgba(255,255,255,0.3); }

  .chat { max-width:800px; margin:20px auto 100px; display:flex; flex-direction:column; gap:20px; }
  .msg { display:flex; transition: all 0.5s ease; }
  .msg .bubble {
    padding:14px; border-radius:20px; max-width:80%; white-space:pre-wrap;
    line-height:1.5; font-size:15px;
    color:var(--text-color);
    transition: background 1s ease-in-out, color 0.6s ease;
  }
  .msg.user { justify-content:flex-end; }
  .msg.user .bubble { background:var(--user-bubble); }
  .msg.assistant { justify-content:flex-start; }
  .msg.assistant .bubble { background:var(--bot-bubble); }

  pre, code {
    background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
    background-size: 200% 200%;
    animation: gradientMove 10s ease infinite;
    color: var(--code-fg);
    font-family:Consolas, monospace;
    padding:10px;
    border-radius:10px;
    overflow-x:auto;
    display:block;
    transition: background 1s ease-in-out, color 0.6s ease;
  }

  .composer { position:fixed; bottom:0; left:0; right:0;
    background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
    background-size: 200% 200%;
    animation: gradientMove 6s ease infinite;
    border-top:1px solid rgba(255,255,255,0.2);
    transition: background 1s ease-in-out;
  }
  .composer .inner { max-width:800px; margin:0 auto; display:flex; gap:10px; padding:10px; }
  textarea { flex:1; resize:none; min-height:54px; border-radius:10px; border:none; padding:10px; }
  button.send { padding:12px 16px; border-radius:10px; border:none; cursor:pointer; background:rgba(255,255,255,0.15); color:var(--text-color); }

  /* Animazione gradiente fluida */
  @keyframes gradientMove {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
</style>
</head>
<body data-theme="light">

<header>
  <div style="flex:1; display:flex;">
    <input id="apiKey" type="password" placeholder="Groq API Key (gsk_xxx)" />
    <input id="model" type="text" value="llama3-8b-8192" />
  </div>
  <button id="toggleTheme">🌙</button>
</header>

<div id="chat" class="chat"></div>

<div class="composer">
  <div class="inner">
    <textarea id="input" placeholder="Scrivi qui..."></textarea>
    <button class="send" id="send">Invia</button>
  </div>
</div>

<script>
(() => {
  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("send");
  const apiKeyEl = document.getElementById("apiKey");
  const modelEl = document.getElementById("model");
  const toggleBtn = document.getElementById("toggleTheme");

  let theme = "light";

  toggleBtn.addEventListener("click", () => {
    theme = theme === "light" ? "dark" : "light";
    document.body.setAttribute("data-theme", theme);
    toggleBtn.textContent = theme === "light" ? "🌙" : "☀️";
  });

  const messages = [];

  function formatMessage(text) {
    return text
      .replace(/```(.*?)\n([\s\S]*?)```/g, (m, lang, code) => {
        return `<pre><code>${code.replace(/</g,"&lt;").replace(/>/g,"&gt;")}</code></pre>`;
      })
      .replace(/`([^`]+)`/g, "<code>$1</code>")
      .replace(/\n- (.*?)/g, "<br>👉 $1");
  }

  function addMessage(role, text="") {
    const row = document.createElement("div");
    row.className = "msg " + role;
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerHTML = formatMessage(text);
    row.appendChild(bubble);
    chatEl.appendChild(row);
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    return bubble;
  }

  async function callGroq(userText) {
    const apiKey = apiKeyEl.value.trim();
    const model = modelEl.value.trim();
    if (!apiKey) throw new Error("Inserisci la tua API Key Groq");

    messages.push({ role: "user", content: userText });

    const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + apiKey
      },
      body: JSON.stringify({
        model: model || "llama3-8b-8192",
        messages: messages,
        stream: true
      })
    });

    if (!res.ok) throw new Error("Errore API (" + res.status + "): " + await res.text());

    const reader = res.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let assistantText = "";
    const bubble = addMessage("assistant", "");

    while (true) {
      const {done, value} = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value, {stream:true});
      const lines = chunk.split("\n").filter(l => l.trim().startsWith("data:"));
      for (const line of lines) {
        const dataStr = line.replace(/^data:\s*/, "");
        if (dataStr === "[DONE]") {
          messages.push({ role: "assistant", content: assistantText });
          bubble.innerHTML = formatMessage(assistantText);
          return;
        }
        try {
          const data = JSON.parse(dataStr);
          const delta = data.choices[0]?.delta?.content || "";
          if (delta) {
            assistantText += delta;
            bubble.innerHTML = formatMessage(assistantText);
            window.scrollTo({ top: document.body.scrollHeight });
          }
        } catch {}
      }
    }
  }

  async function send() {
    const txt = inputEl.value.trim();
    if (!txt) return;
    addMessage("user", txt);
    inputEl.value = "";
    try {
      await callGroq(txt);
    } catch (err) {
      addMessage("assistant", "⚠️ " + err.message);
    }
  }

  sendBtn.addEventListener("click", send);
  inputEl.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); }
  });
})();
</script>
</body>
</html>
